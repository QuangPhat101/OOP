# BÃO CÃO Äá»’ ÃN TÃŒM HIá»‚U Vá»€ OLLAMA  
## 1. THÃ”NG TIN 

**Äá» tÃ i:** Chatbot Há»— Trá»£ Há»c Láº­p TrÃ¬nh báº±ng C++ thÃ´ng qua Ollama (GPT-OSS:20B)  
**NgÆ°á»i thá»±c hiá»‡n:** Nguyá»…n Quang PhÃ¡t  
**MSSV:** 24120117  
**Thá»i gian thá»±c hiá»‡n:** tá»« 18/11/2025 Ä‘áº¿n 28/12/2025    

---

## 2. GIá»šI THIá»†U Äá»’ ÃN

### 2.1. Má»¥c tiÃªu
XÃ¢y dá»±ng má»™t á»©ng dá»¥ng Console trÃªn C++ Ä‘Ã³ng vai trÃ² lÃ  Client Ä‘á»ƒ giao tiáº¿p vá»›i Server AI (Ollama) thÃ´ng qua API. á»¨ng dá»¥ng há»— trá»£ chat thá»i gian thá»±c (Streaming response), quáº£n lÃ½ lá»‹ch sá»­ há»™i thoáº¡i vÃ  tÃ¹y chá»‰nh model.

### 2.2. CÃ´ng nghá»‡ sá»­ dá»¥ng
* **NgÃ´n ngá»¯:** C++ .
* **ThÆ° viá»‡n Network:** `libcurl` (Xá»­ lÃ½ HTTP Request/Response).
* **ThÆ° viá»‡n JSON:** `nlohmann/json` (Xá»­ lÃ½ dá»¯ liá»‡u JSON gá»­i/nháº­n).
* **API:** Ollama API (thÃ´ng qua `ngrok` tunnel).

### 2.3 Cáº¤U TRÃšC Táº¬P TIN  
â”œâ”€â”€ ChatSession.h      
â”œâ”€â”€ OllamaClient.h     
â”œâ”€â”€ Message.h          
â”œâ”€â”€ ngrok_url.h        
â”œâ”€â”€ main.cpp           
â”œâ”€â”€ ChatSession.cpp    
â”œâ”€â”€ OllamaClient.cpp   
â”œâ”€â”€ Message.cpp           
â”œâ”€â”€ libcurl             
â””â”€â”€ nlohmann/json.hpp    

## 3. TIáº¾N Äá»˜ THá»°C HIá»†N VÃ€ CHá»¨C NÄ‚NG
Báº£ng dÆ°á»›i Ä‘Ã¢y mÃ´ táº£ chi tiáº¿t lá»™ trÃ¬nh phÃ¡t triá»ƒn vÃ  cÃ¡c chá»©c nÄƒng Ä‘Ã£ Ä‘Æ°á»£c hiá»‡n thá»±c trong source code:

| Chá»©c nÄƒng (Feature) | Chi tiáº¿t hiá»‡n thá»±c (Dá»±a trÃªn Source Code) | Tuáº§n dá»± kiáº¿n | Ghi chÃº & LiÃªn káº¿t Flowchart |
| :--- | :--- | :--- | :--- |
| **I. Thiáº¿t láº­p Há»‡ thá»‘ng & Káº¿t ná»‘i** | **Khá»Ÿi táº¡o vÃ  cáº¥u hÃ¬nh Client** | **1-2** | **THIáº¾T Láº¬P** |
| 1. Cáº¥u hÃ¬nh káº¿t ná»‘i Ollama | Load URL tá»« `ngrok_url.h`, khá»Ÿi táº¡o `OllamaClient` vá»›i model máº·c Ä‘á»‹nh "gpt-oss:20b" | 1 | Ã” "Khá»Ÿi táº¡o káº¿t ná»‘i..." |
| 2. Khá»Ÿi táº¡o phiÃªn lÃ m viá»‡c | `ChatSession` hiá»ƒn thá»‹ banner, thÃ´ng tin model hiá»‡n táº¡i vÃ  hÆ°á»›ng dáº«n sá»­ dá»¥ng | 2 | Ã” "Táº¡o phiÃªn chat má»›i..." |
| --- | --- | --- | --- |
| **II. Xá»­ lÃ½ Input & Quáº£n lÃ½ Lá»‡nh** | **VÃ²ng láº·p tÆ°Æ¡ng tÃ¡c ngÆ°á»i dÃ¹ng** | **2-3** | **Xá»¬ LÃ Lá»†NH** |
| 3. Nháº­n input | VÃ²ng láº·p `while(session.active())` trong `main.cpp`, xá»­ lÃ½ xÃ³a khoáº£ng tráº¯ng (trim) | 2 | Ã” "Nháº­n input" |
| 4. PhÃ¢n loáº¡i input | Kiá»ƒm tra tiá»n tá»‘ "/" Ä‘á»ƒ phÃ¢n biá»‡t lá»‡nh há»‡ thá»‘ng vÃ  tin nháº¯n chat | 2 | Decision â—‡ "PhÃ¢n tÃ­ch loáº¡i input..." |
| 5. Há»‡ thá»‘ng lá»‡nh Ä‘áº·c biá»‡t | Xá»­ lÃ½ cÃ¡c lá»‡nh: `/exit` (thoÃ¡t), `/help` (hÆ°á»›ng dáº«n), `/clear` (xÃ³a sá»­), `/history` (xem láº¡i), vÃ  **/model** (Ä‘á»•i model) | 3 | Ã” "Xá»­ lÃ­ lá»‡nh Ä‘áº·c biá»‡t..." |
| --- | --- | --- | --- |
| **III. Xá»­ lÃ½ CÃ¢u há»i & Gá»i API** | **Logic gá»­i request AI** | **3-4** | **Gá»¬I REQUEST** |
| 6. Quáº£n lÃ½ ngá»¯ cáº£nh | Class `Message` lÆ°u trá»¯ role/content. Vector `history` lÆ°u toÃ n bá»™ há»™i thoáº¡i | 3 | Ã” "LÆ°u cÃ¢u há»i vÃ o lá»‹ch sá»­" |
| 7. Chuáº©n bá»‹ Payload JSON | ThÃªm **System Prompt** (Role chuyÃªn gia C++), cÃ i Ä‘áº·t tham sá»‘ sinh (`num_predict`: 4096, `temperature`: 0.7) | 3 | Ã” "Chuáº©n bá»‹ dá»¯ liá»‡u (System Prompt + History)..." |
| 8. ÄÃ³ng gÃ³i Request | Serialize dá»¯ liá»‡u sang JSON string dÃ¹ng thÆ° viá»‡n ngáº§m Ä‘á»‹nh | 3 | Ã” "ÄÃ³ng gÃ³i thÃ nh JSON format" |
| 9. Thá»±c thi HTTP Request | Thiáº¿t láº­p `libcurl`: POST method, Header `application/json`, Ä‘Äƒng kÃ½ Callback function | 4 | Ã” "Gá»­i HTTP POST request..." |
| --- | --- | --- | --- |
| **IV. Streaming Response** | **Xá»­ lÃ½ pháº£n há»“i thá»i gian thá»±c** | **4-5** | **STREAMING & HIá»‚N THá»Š** |
| 10. CÆ¡ cháº¿ Callback | HÃ m `StreamCallback` nháº­n dá»¯ liá»‡u tá»«ng pháº§n tá»« Curl khi server Ä‘ang generate | 4 | Ã” "Chatbot nháº­n chunk dá»¯ liá»‡u..." |
| 11. Xá»­ lÃ½ NDJSON | TÃ¡ch buffer theo kÃ½ tá»± xuá»‘ng dÃ²ng `\n`, parse tá»«ng dÃ²ng JSON riÃªng biá»‡t | 4 | Ã” "Parse tá»«ng dÃ²ng JSON (NDJSON)..." |
| 12. Hiá»ƒn thá»‹ Real-time | TrÃ­ch xuáº¥t `["message"]["content"]` vÃ  in ra `std::cout` ngay láº­p tá»©c (hiá»‡u á»©ng gÃµ mÃ¡y) | 4-5 | Ã” "TrÃ­ch xuáº¥t vÃ  hiá»ƒn thá»‹ ná»™i dung..." |
| 13. Tá»•ng há»£p pháº£n há»“i | GhÃ©p ná»‘i toÃ n bá»™ cÃ¡c máº£nh content thÃ nh chuá»—i hoÃ n chá»‰nh Ä‘á»ƒ lÆ°u vÃ o history sau khi stream xong | 5 | Ã” "LÆ°u cÃ¢u tráº£ lá»i Ä‘áº§y Ä‘á»§ vÃ o lá»‹ch sá»­" |
| --- | --- | --- | --- |
| **V. HoÃ n thiá»‡n** | **Testing & ÄÃ³ng gÃ³i** | **5-6** | **HOÃ€N THIá»†N** |
| 14. Kiá»ƒm thá»­ tÃ­ch há»£p | Cháº¡y thá»­ nghiá»‡m vá»›i ngrok tunnel thá»±c táº¿, kiá»ƒm tra kháº£ nÄƒng nhá»› ngá»¯ cáº£nh cá»§a AI | 5 | Kiá»ƒm tra luá»“ng cháº¡y thá»±c táº¿ |
| 15. Tá»‘i Æ°u hÃ³a | Xá»­ lÃ½ lá»—i káº¿t ná»‘i (`CURLE_OK`), xá»­ lÃ½ exception khi parse JSON lá»—i | 6 | Xá»­ lÃ½ ngoáº¡i lá»‡ (Try-catch) |

## 4. CHÆ¯Æ NG TRÃŒNH 
### 4.1 CÃC CHá»¨C NÄ‚NG  

### 4.1.1 CÃ¡c lá»‡nh cÃ³ sáºµn:
- `/help` - Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n
- `/history` - Xem lá»‹ch sá»­ há»™i thoáº¡i
- `/clear` - XÃ³a lá»‹ch sá»­
- `/exit` hoáº·c `/quit` - ThoÃ¡t chÆ°Æ¡ng trÃ¬nh

### 4.1.2 VÃ­ dá»¥ há»™i thoáº¡i:
```
ğŸ‘¤ Báº¡n: Giáº£i thÃ­ch con trá» trong C++

ğŸ¤– AI: Con trá» lÃ  biáº¿n lÆ°u Ä‘á»‹a chá»‰ bá»™ nhá»›...
(streaming response)

ğŸ‘¤ Báº¡n: Cho tÃ´i vÃ­ dá»¥ code

ğŸ¤– AI: ÄÃ¢y lÃ  vÃ­ dá»¥ vá» con trá»:
int x = 10;
int* ptr = &x;
...
```

### 4.1.3 Tuá»³ chá»‰nh
### Äá»•i model:
Trong `main.cpp`:
```cpp
OllamaClient client(OLLAMA_API_URL, "llama3");  // Äá»•i model
```

### Äá»•i system prompt:
Trong `OllamaClient.cpp`, method `sendMessage()`:
```cpp
{"content", "Báº¡n lÃ  trá»£ lÃ½ AI..."}  // Sá»­a á»Ÿ Ä‘Ã¢y
```

### 4.2 BIÃŠN Dá»ŠCH CHÆ¯Æ NG TRÃŒNH
### 4.2.1 Táº O SERVER
``` Bash
!sudo apt update
!sudo apt install -y pciutils
!curl -fsSL https://ollama.com/install.sh | sh

import os
env = os.environ.copy()
env["OLLAMA_HOST"] = "0.0.0.0"
env["OLLAMA_ORIGINS"] = "*"

import subprocess
def run_ollama_serve():
  subprocess.Popen(["ollama", "serve"], env=env)

import threading
thread = threading.Thread(target=run_ollama_serve)
thread.start()

import time
time.sleep(5)

!ollama pull gpt-oss:20b
```

``` Bash
!curl http://localhost:11434/api/generate -d '{ "model": "gpt-oss:20b", "prompt": "Who are you?", "stream": false}'
```

``` Bash
%pip install pyngrok
from pyngrok import ngrok

from kaggle_secrets import UserSecretsClient
user_secrets = UserSecretsClient()
ngrok_api_key = user_secrets.get_secret("ngrok-api-key")
ngrok.set_auth_token(ngrok_api_key) 

port = 11434 
public_url = ngrok.connect(port).public_url
print(f" * ngrok tunnel {public_url} -> http://127.0.0.1:{port}")
```

``` Bash
!curl https://dionna-squarelike-centrically.ngrok-free.dev/api/generate -d '{ "model": "gpt-oss:20b", "prompt": "Who are you?", "stream": false}'
```

``` Bash
ngrok.kill() #Chá»‰ cháº¡y khi muá»‘n táº¯t server
```

### 4.2.1. BiÃªn dá»‹ch chÆ°Æ¡ng trÃ¬nh:
```bash
make
```

### Cháº¡y chÆ°Æ¡ng trÃ¬nh:
```bash
./chatbot
```

### XÃ³a file rÃ¡c Ä‘á»ƒ cháº¡y láº¡i tá»« Ä‘áº§u(khi Ä‘Ã£ káº¿t thÃºc chÆ°Æ¡ng trÃ¬nh):
```bash
make clean
```

### 4.3 Xá»­ lÃ½ lá»—i thÆ°á»ng gáº·p

### Lá»—i: `undefined reference to curl_*`
â†’ Thiáº¿u `-lcurl` khi compile. DÃ¹ng Makefile Ä‘Ã£ cung cáº¥p.

### Lá»—i: Cannot connect to API
â†’ Kiá»ƒm tra `ngrok_url.h` cÃ³ Ä‘Ãºng URL khÃ´ng, Ollama server cÃ³ Ä‘ang cháº¡y khÃ´ng.

### Streaming khÃ´ng hoáº¡t Ä‘á»™ng
â†’ Kiá»ƒm tra `"stream": true` trong `OllamaClient.cpp`

## 5. QUY TRÃŒNH LÃ€M VIá»†C

Äá»ƒ dá»± Ã¡n luÃ´n á»•n Ä‘á»‹nh, dá»… kiá»ƒm soÃ¡t vÃ  thuáº­n tiá»‡n má»Ÿ rá»™ng sau nÃ y, cáº§n pháº£i Ã¡p dá»¥ng má»™t quy trÃ¬nh rÃµ rÃ ng.

### 5.1. QUáº¢N LÃ MÃƒ NGUá»’N
Sá»­ dá»¥ng **Git** vÃ  **GitHub** Ä‘á»ƒ quáº£n lÃ½ phiÃªn báº£n.

- **Repository:** Má»™t repo duy nháº¥t chá»©a toÃ n bá»™ mÃ£ nguá»“n vá»›i Ä‘Æ°á»ng dáº«n
```Bash
https://github.com/QuangPhat101/OllamaProject
```
- **Branching:**  
  - NhÃ¡nh `main` luÃ´n giá»¯ tráº¡ng thÃ¡i á»•n Ä‘á»‹nh.  
  - Má»—i tÃ­nh nÄƒng má»›i Ä‘Æ°á»£c phÃ¡t triá»ƒn trÃªn nhÃ¡nh riÃªng `feature/...`.
- **Pull Request & tá»± review:**  
  Sau khi hoÃ n thÃ nh má»™t tÃ­nh nÄƒng, táº¡o Pull Request Ä‘á»ƒ kiá»ƒm tra láº¡i:  
  - Kiá»ƒm tra logic hoáº¡t Ä‘á»™ng.  
  - Äáº£m báº£o tuÃ¢n thá»§ convention.  
  - Refactor náº¿u cáº§n.  
  Viá»‡c nÃ y giÃºp mÃ£ sáº¡ch, cÃ³ tá»• chá»©c vÃ  giáº£m thiá»ƒu lá»—i.

### 5.2. CÃCH Tá»” CHá»¨C 
Ãp dá»¥ng kiáº¿n trÃºc **Layered Architecture**:

- **UI layer:** Xá»­ lÃ½ giao diá»‡n, nháº­p/xuáº¥t dá»¯ liá»‡u.
- **BLL layer:** Chá»©a toÃ n bá»™ logic nghiá»‡p vá»¥, OOP, thuáº­t toÃ¡n.
- **DAL layer:** Äá»c/ghi dá»¯ liá»‡u (file, cÆ¡ sá»Ÿ dá»¯ liá»‡u...).

Má»—i tÃ­nh nÄƒng Ä‘Æ°á»£c thá»±c hiá»‡n theo thá»© tá»±:
1. XÃ¡c Ä‘á»‹nh yÃªu cáº§u tá»« giao diá»‡n.  
2. Viáº¿t chá»©c nÄƒng tÆ°Æ¡ng á»©ng á»Ÿ BLL.  
3. Bá»• sung xá»­ lÃ½ dá»¯ liá»‡u á»Ÿ DAL náº¿u cáº§n.

CÃ¡ch lÃ m nÃ y giÃºp cÃ¡c pháº§n káº¿t ná»‘i rÃµ rÃ ng, dá»… báº£o trÃ¬ vÃ  má»Ÿ rá»™ng.

### 5.3. THEO DÃ•I TIáº¾N Äá»˜ CÃ”NG VIá»†C
Sá»­ dá»¥ng **Kanban** (Trello hoáº·c GitHub Projects) Ä‘á»ƒ quáº£n lÃ½ cÃ´ng viá»‡c:

- **To Do** â€“ viá»‡c cáº§n lÃ m  
- **In Progress** â€“ Ä‘ang thá»±c hiá»‡n  
- **In Review** â€“ Ä‘Ã£ hoÃ n thÃ nh code, Ä‘ang kiá»ƒm tra láº¡i  
- **Done** â€“ hoÃ n táº¥t  

Cuá»‘i tuáº§n, xem láº¡i tiáº¿n Ä‘á»™ vÃ  Ä‘iá»u chá»‰nh káº¿ hoáº¡ch náº¿u cáº§n.

---

## 6. CÃCH Táº O MÃƒ NGUá»’N CHáº¤T LÆ¯á»¢NG

### 6.1. CODING CONVENTION
Ãp dá»¥ng quy táº¯c rÃºt gá»n tá»«:
- C++ Core Guidelines  
- Google C++ Style Guide  
- CÃ¡c nguyÃªn táº¯c láº­p trÃ¬nh tá»‘t tá»« giáº£ng viÃªn

#### 6.1.1. QUY Táº®C Äáº¶T TÃŠN
- **Class/Struct:** `PascalCase`
- **HÃ m:** `camelCase`
- **Thuá»™c tÃ­nh:** `_camelCase`
- **Biáº¿n cá»¥c bá»™:** `camelCase`
- **Háº±ng sá»‘:** `ALL_UPPERCASE`  
- TrÃ¡nh magic numbers.

#### 6.1.2. QUY Táº®C Äá»ŠNH Dáº NG
- Thá»¥t lá» 4 spaces (khÃ´ng dÃ¹ng tab).  
- Dáº¥u `{` Ä‘áº·t cuá»‘i dÃ²ng lá»‡nh Ä‘iá»u kiá»‡n hoáº·c hÃ m.  
- LuÃ´n cÃ³ khoáº£ng tráº¯ng quanh toÃ¡n tá»­ vÃ  sau dáº¥u pháº©y.  
- TrÃ¡nh biá»ƒu thá»©c gÃ¢y nháº§m láº«n (vd: `a[i] = i++`).  
- Æ¯u tiÃªn `if (ptr)` thay vÃ¬ `if (ptr != nullptr)`.

#### 6.1.3. Tá»” CHá»¨C FILE
- TÃ¡ch riÃªng `.h` vÃ  `.cpp`.  
- Thá»© tá»± include: STL â†’ thÆ° viá»‡n ngoÃ i â†’ file ná»™i bá»™.  
- LuÃ´n dÃ¹ng include guards.  
- KhÃ´ng dÃ¹ng `using namespace std;`.

#### 6.1.4. Táº O COMMENT COMMENT
- Viáº¿t comment theo Doxygen cho class vÃ  hÃ m.  
- Chá»‰ comment **vÃ¬ sao**, khÃ´ng comment **cÃ¡i gÃ¬**.

#### 6.1.5. CÃC QUY Táº®C KHÃC
- DÃ¹ng `nullptr` thay `NULL`.  
- Khai bÃ¡o má»—i biáº¿n má»™t dÃ²ng.  
- TrÃ¡nh `std::endl`.  
- CÃ³ thá»ƒ dÃ¹ng `std::expected` thay `try/catch`.

---

## 6.2. NGUYÃŠN Táº®C THIáº¾T Káº¾

### 6.2.1. SOLID
Ãp dá»¥ng Ä‘áº§y Ä‘á»§ 5 nguyÃªn táº¯c Ä‘á»ƒ code dá»… má»Ÿ rá»™ng vÃ  báº£o trÃ¬:
- **SRP** â€“ Má»—i class chá»‰ lÃ m má»™t viá»‡c.  
- **OCP** â€“ Má»Ÿ rá»™ng dá»…, Ã­t sá»­a code cÅ©.  
- **LSP** â€“ Lá»›p con thay tháº¿ Ä‘Æ°á»£c lá»›p cha.  
- **ISP** â€“ Interface nhá», Ä‘Ãºng má»¥c Ä‘Ã­ch.  
- **DIP** â€“ Lá»›p cáº¥p cao phá»¥ thuá»™c abstraction, khÃ´ng phá»¥ thuá»™c chi tiáº¿t.

### 6.2.2. KISS
Æ¯u tiÃªn giáº£i phÃ¡p Ä‘Æ¡n giáº£n nháº¥t cÃ³ thá»ƒ.

### 6.2.3. DRY
KhÃ´ng láº·p láº¡i logic â€“ náº¿u tháº¥y láº·p, refactor ngay.

---

## 6.3. QUY Táº®C TESTING

### 6.3.1. UNIT TEST
Sá»­ dá»¥ng **Google Test** Ä‘á»ƒ kiá»ƒm tra tá»«ng class vÃ  hÃ m.  
Viáº¿t test song song vá»›i code Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh Ä‘Ãºng Ä‘áº¯n vÃ  giáº£m lá»—i.

### 6.3.2. MANUAL TEST
Sau khi tÃ­ch há»£p cÃ¡c layer, cháº¡y thá»­ cÃ¡c ká»‹ch báº£n ngÆ°á»i dÃ¹ng Ä‘á»ƒ kiá»ƒm tra toÃ n bá»™ há»‡ thá»‘ng hoáº¡t Ä‘á»™ng nhÆ° mong Ä‘á»£i.

---

## 6.4. KIáº¾N TRÃšC MÃƒ NGUá»’N
Ãp dá»¥ng **Layered Architecture** vá»›i 3 lá»›p:

1. **UI (Presentation):** Giao diá»‡n ngÆ°á»i dÃ¹ng.  
2. **BLL (Business Logic):** Xá»­ lÃ½ nghiá»‡p vá»¥, OOP, thuáº­t toÃ¡n.  
3. **DAL (Data Access):** Äá»c/ghi dá»¯ liá»‡u.  

Kiáº¿n trÃºc nÃ y giÃºp mÃ£ rÃµ rÃ ng, dá»… test vÃ  dá»… nÃ¢ng cáº¥p (vÃ­ dá»¥: tá»« file sang database).

---

## 6.5. DESIGN PATTERN

### 6.5.1. FACADE PATTERN
Má»™t lá»›p trung gian che giáº¥u Ä‘á»™ phá»©c táº¡p cá»§a há»‡ thá»‘ng con, cung cáº¥p API Ä‘Æ¡n giáº£n cho cÃ¡c layer khÃ¡c.

### 6.5.2. SIMPLE FACTORY
Táº¡o Ä‘á»‘i tÆ°á»£ng phÃ¹ há»£p dá»±a trÃªn input mÃ  khÃ´ng Ä‘á»ƒ client biáº¿t chi tiáº¿t triá»ƒn khai.

### 6.5.3. SINGLETON
Äáº£m báº£o chá»‰ cÃ³ má»™t instance duy nháº¥t cá»§a má»™t lá»›p trong toÃ n bá»™ chÆ°Æ¡ng trÃ¬nh.


## 7. TÃ i liá»‡u tham kháº£o
- [Ollama API Documentation](https://github.com/ollama/ollama/blob/main/docs/api.md)
- [nlohmann/json](https://github.com/nlohmann/json)
- [libcurl](https://curl.se/libcurl/)